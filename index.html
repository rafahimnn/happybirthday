<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÇ Special Birthday Celebration</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #ff006e;
            --secondary: #8338ec;
            --accent: #06ffa5;
            --gold: #ffd700;
            --pink: #ff1493;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a0033 0%, #000 50%, #330066 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Navigation */
        .nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            padding: 15px;
            display: flex;
            justify-content: space-around;
            z-index: 1000;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .nav-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 10px;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .nav-btn span {
            font-size: 0.7rem;
        }

        .nav-btn:hover, .nav-btn.active {
            color: var(--accent);
            transform: scale(1.1);
        }

        /* Sections */
        .section {
            display: none;
            padding: 80px 20px 100px;
            max-width: 800px;
            margin: 0 auto;
            animation: fadeIn 0.5s;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Header */
        .header {
            text-align: center;
            padding: 30px 20px;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, var(--gold), var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .birthday-person {
            font-size: 3rem;
            color: var(--gold);
            text-shadow: 0 0 30px rgba(255,215,0,0.5);
            font-family: 'Dancing Script', cursive;
        }

        /* Cake Section */
        .cake-container {
            text-align: center;
            padding: 20px;
        }

        .cake-wrapper {
            position: relative;
            width: 300px;
            height: 400px;
            margin: 0 auto;
        }

        .cake-base {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 250px;
            height: 120px;
            background: linear-gradient(135deg, #8B4513, #D2691E);
            border-radius: 20px 20px 40px 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .cake-middle {
            position: absolute;
            bottom: 110px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 100px;
            background: linear-gradient(135deg, #FF69B4, #FFB6C1);
            border-radius: 15px;
        }

        .cake-top {
            position: absolute;
            bottom: 200px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 80px;
            background: linear-gradient(135deg, #FFF8DC, #F5DEB3);
            border-radius: 10px;
        }

        .candle {
            position: absolute;
            width: 20px;
            height: 60px;
            background: linear-gradient(to right, #ff006e, #ff1493);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .candle::before {
            content: '';
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 40px;
            background: radial-gradient(ellipse at bottom, #ffd700, #ff8c00, transparent);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            animation: flicker 0.5s infinite alternate;
            box-shadow: 0 0 20px #ff8c00;
        }

        @keyframes flicker {
            0% { transform: translateX(-50%) scale(1) rotate(-2deg); }
            100% { transform: translateX(-50%) scale(1.1) rotate(2deg); }
        }

        .candle.blown::before {
            display: none;
        }

        .candle:nth-child(4) { bottom: 280px; left: 35%; }
        .candle:nth-child(5) { bottom: 280px; left: 50%; transform: translateX(-50%); }
        .candle:nth-child(6) { bottom: 280px; right: 35%; }

        .cut-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(255,255,255,0.5);
            display: none;
            pointer-events: none;
        }

        .cake-slice {
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
            display: none;
        }

        .blow-btn {
            margin-top: 30px;
            padding: 15px 40px;
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            border: none;
            border-radius: 50px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .cut-btn {
            margin-top: 20px;
            padding: 15px 40px;
            background: linear-gradient(45deg, var(--accent), #00d4ff);
            border: none;
            border-radius: 50px;
            color: #000;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            display: none;
        }

        /* Photo Album */
        .upload-area {
            border: 3px dashed rgba(255,255,255,0.3);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: var(--accent);
            background: rgba(6,255,165,0.1);
        }

        .upload-area input {
            display: none;
        }

        .upload-btn {
            padding: 15px 30px;
            background: var(--primary);
            border: none;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            font-size: 1rem;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .photo-item {
            aspect-ratio: 1;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .photo-item:hover {
            transform: scale(1.05);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item .delete {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,0,0,0.8);
            border: none;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8rem;
        }

        /* Video Section */
        .video-box {
            width: 100%;
            max-width: 600px;
            height: 400px;
            background: #000;
            border-radius: 20px;
            margin: 0 auto 20px;
            overflow: hidden;
            border: 3px solid var(--accent);
            position: relative;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .rec-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s;
        }

        .btn-record { background: #ff0000; color: white; }
        .btn-stop { background: #333; color: white; }
        .btn-upload { background: linear-gradient(45deg, var(--accent), #00d4ff); color: #000; font-weight: bold; }
        .btn:hover { transform: scale(1.05); }

        .videos-list {
            display: grid;
            gap: 20px;
        }

        .video-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            overflow: hidden;
        }

        .video-card video {
            width: 100%;
            height: 200px;
        }

        .video-info {
            padding: 15px;
        }

        /* Letter Section */
        .letter-container {
            background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,0,110,0.1));
            border: 2px solid rgba(255,215,0,0.3);
            border-radius: 20px;
            padding: 30px;
            position: relative;
        }

        .letter-paper {
            background: #fffef0;
            color: #333;
            padding: 30px;
            border-radius: 10px;
            min-height: 400px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            font-family: 'Dancing Script', cursive;
            font-size: 1.3rem;
            line-height: 1.8;
        }

        .letter-input {
            width: 100%;
            min-height: 300px;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: inherit;
            line-height: inherit;
            resize: vertical;
            outline: none;
        }

        .letter-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        .saved-letters {
            margin-top: 30px;
        }

        .letter-item {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--gold);
        }

        .letter-author {
            color: var(--accent);
            font-weight: bold;
            margin-bottom: 10px;
        }

        .letter-date {
            color: #888;
            font-size: 0.85rem;
            margin-top: 10px;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Lightbox */
        .lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
        }

        .lightbox .close {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 3rem;
            color: white;
            cursor: pointer;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8rem; }
            .birthday-person { font-size: 2rem; }
            .cake-wrapper { width: 250px; height: 350px; }
            .cake-base { width: 200px; height: 100px; }
            .cake-middle { width: 160px; height: 80px; bottom: 90px; }
            .cake-top { width: 120px; height: 60px; bottom: 160px; }
            .candle { height: 50px; }
            .candle:nth-child(4) { bottom: 220px; }
            .candle:nth-child(5) { bottom: 220px; }
            .candle:nth-child(6) { bottom: 220px; }
            .video-box { height: 250px; }
            .nav-btn { font-size: 1.2rem; }
            .nav-btn span { font-size: 0.6rem; }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- Lightbox -->
    <div class="lightbox" id="lightbox" onclick="closeLightbox()">
        <span class="close">&times;</span>
        <img src="" alt="Full size" id="lightboxImg">
    </div>

    <!-- Header -->
    <div class="header">
        <h1>üéâ Happy Birthday üéÇ</h1>
        <div class="birthday-person" id="birthdayName">‡¶™‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶ú‡¶®</div>
        <p style="color: #aaa; margin-top: 10px;">‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶∏‡ßç‡¶Æ‡ßÉ‡¶§‡¶ø</p>
    </div>

    <!-- CAKE SECTION -->
    <div class="section active" id="cakeSection">
        <div class="cake-container">
            <div class="cake-wrapper" id="cake">
                <div class="cake-base"></div>
                <div class="cake-middle"></div>
                <div class="cake-top"></div>
                <div class="candle" onclick="blowCandle(this)"></div>
                <div class="candle" onclick="blowCandle(this)"></div>
                <div class="candle" onclick="blowCandle(this)"></div>
            </div>
            
            <button class="blow-btn" id="blowBtn" onclick="blowAllCandles()">
                üå¨Ô∏è ‡¶Æ‡ßã‡¶Æ‡¶¨‡¶æ‡¶§‡¶ø ‡¶®‡¶ø‡¶≠‡¶æ‡¶® (‡¶´‡ßÅ ‡¶¶‡¶ø‡¶®)
            </button>
            
            <button class="cut-btn" id="cutBtn" onclick="cutCake()">
                üî™ ‡¶ï‡ßá‡¶ï ‡¶ï‡¶æ‡¶ü‡ßÅ‡¶®
            </button>
            
            <p id="cakeMessage" style="margin-top: 20px; color: var(--accent); opacity: 0; transition: all 0.5s;">
                üéâ ‡¶∂‡ßÅ‡¶≠ ‡¶ú‡¶®‡ßç‡¶Æ‡¶¶‡¶ø‡¶®! üéâ
            </p>
        </div>
    </div>

    <!-- PHOTO SECTION -->
    <div class="section" id="photoSection">
        <h2 style="text-align: center; margin-bottom: 20px; color: var(--gold);">üì∏ Photo Album</h2>
        
        <div class="upload-area" onclick="document.getElementById('photoInput').click()">
            <input type="file" id="photoInput" accept="image/*" multiple onchange="handlePhotos(event)">
            <p style="font-size: 3rem; margin-bottom: 10px;">üì∑</p>
            <p>‡¶´‡ßã‡¶ü‡ßã ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</p>
            <p style="color: #888; font-size: 0.9rem; margin-top: 10px;">‡¶Ö‡¶•‡¶¨‡¶æ ‡¶°‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</p>
        </div>

        <div class="loading" id="photoLoading">
            <div class="spinner"></div>
            <p>‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
        </div>

        <div class="photo-grid" id="photoGrid">
            <!-- Photos will appear here -->
        </div>
    </div>

    <!-- VIDEO SECTION -->
    <div class="section" id="videoSection">
        <h2 style="text-align: center; margin-bottom: 20px; color: var(--accent);">üé• Birthday Wishes</h2>
        
        <div class="video-box">
            <video id="previewVideo" autoplay playsinline muted></video>
            <video id="recordedVideo" class="hidden" controls></video>
        </div>

        <div class="rec-controls">
            <button class="btn btn-record" onclick="startRecording()">üî¥ Record</button>
            <button class="btn btn-stop" onclick="stopRecording()">‚èπÔ∏è Stop</button>
            <button class="btn btn-upload hidden" id="uploadVideoBtn" onclick="uploadVideo()">üöÄ Upload</button>
        </div>

        <div class="loading" id="videoLoading">
            <div class="spinner"></div>
            <p>‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
        </div>

        <div class="videos-list" id="videosList">
            <!-- Videos will appear here -->
        </div>
    </div>

    <!-- LETTER SECTION -->
    <div class="section" id="letterSection">
        <h2 style="text-align: center; margin-bottom: 20px; color: var(--pink);">üíå Birthday Letter</h2>
        
        <div class="letter-container">
            <div class="letter-paper">
                <input type="text" id="letterAuthor" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ" style="width: 100%; border: none; border-bottom: 2px solid #ddd; margin-bottom: 20px; padding: 10px; font-size: 1.1rem; outline: none;">
                <textarea class="letter-input" id="letterContent" placeholder="‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ö‡¶ø‡¶†‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...&#10;&#10;‡¶™‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶ú‡¶®‡ßç‡¶Æ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∑,&#10;&#10;‡¶§‡ßã‡¶Æ‡¶æ‡¶ï‡ßá ‡¶Ö‡¶®‡ßá‡¶ï ‡¶Ö‡¶®‡ßá‡¶ï ‡¶∂‡ßÅ‡¶≠‡ßá‡¶ö‡ßç‡¶õ‡¶æ..."></textarea>
            </div>
            
            <div class="letter-actions">
                <button class="btn btn-upload" onclick="saveLetter()">üíæ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <button class="btn" style="background: var(--secondary); color: white;" onclick="clearLetter()">üîÑ ‡¶®‡¶§‡ßÅ‡¶®</button>
            </div>
        </div>

        <div class="saved-letters" id="savedLetters">
            <h3 style="color: var(--gold); margin-bottom: 20px;">üìú ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶ö‡¶ø‡¶†‡¶ø</h3>
            <!-- Letters will appear here -->
        </div>
    </div>

    <!-- Navigation -->
    <nav class="nav">
        <button class="nav-btn active" onclick="showSection('cakeSection', this)">
            üéÇ
            <span>‡¶ï‡ßá‡¶ï</span>
        </button>
        <button class="nav-btn" onclick="showSection('photoSection', this)">
            üì∏
            <span>‡¶´‡¶ü‡ßã</span>
        </button>
        <button class="nav-btn" onclick="showSection('videoSection', this)">
            üé•
            <span>‡¶≠‡¶ø‡¶°‡¶ø‡¶ì</span>
        </button>
        <button class="nav-btn" onclick="showSection('letterSection', this)">
            üíå
            <span>‡¶ö‡¶ø‡¶†‡¶ø</span>
        </button>
    </nav>

    <script>
        // ‚ö†Ô∏è CLOUDINARY CONFIG - ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¨‡¶∏‡¶æ‡¶®
        const CLOUD_NAME = 'YOUR_CLOUD_NAME';
        const UPLOAD_PRESET = 'birthday_preset';

        // Variables
        let mediaRecorder;
        let recordedChunks = [];
        let stream;
        let videoBlob;
        let photos = JSON.parse(localStorage.getItem('birthdayPhotos')) || [];
        let videos = JSON.parse(localStorage.getItem('birthdayVideos')) || [];
        let letters = JSON.parse(localStorage.getItem('birthdayLetters')) || [];

        // Initialize
        window.onload = () => {
            initCamera();
            loadPhotos();
            loadVideos();
            loadLetters();
        };

        // Navigation
        function showSection(sectionId, btn) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(sectionId).classList.add('active');
            btn.classList.add('active');
        }

        // CAKE FUNCTIONS
        let blownCandles = 0;

        function blowCandle(candle) {
            if (candle.classList.contains('blown')) return;
            
            candle.classList.add('blown');
            blownCandles++;
            
            // Smoke effect
            createSmoke(candle);
            
            if (blownCandles === 3) {
                document.getElementById('blowBtn').style.display = 'none';
                document.getElementById('cutBtn').style.display = 'inline-block';
                
                confetti({
                    particleCount: 100,
                    spread: 70,
                    colors: ['#ffd700', '#ff8c00']
                });
            }
        }

        function blowAllCandles() {
            document.querySelectorAll('.candle').forEach((candle, index) => {
                setTimeout(() => blowCandle(candle), index * 200);
            });
        }

        function createSmoke(element) {
            for (let i = 0; i < 5; i++) {
                const smoke = document.createElement('div');
                smoke.style.cssText = `
                    position: absolute;
                    width: 20px;
                    height: 20px;
                    background: rgba(200,200,200,0.5);
                    border-radius: 50%;
                    pointer-events: none;
                    animation: smokeUp 1s forwards;
                `;
                smoke.style.left = element.offsetLeft + 10 + 'px';
                smoke.style.top = element.offsetTop - 20 + 'px';
                element.parentElement.appendChild(smoke);
                setTimeout(() => smoke.remove(), 1000);
            }
        }

        function cutCake() {
            const cake = document.getElementById('cake');
            
            // Cut animation
            cake.style.transform = 'scale(0.95)';
            setTimeout(() => cake.style.transform = 'scale(1)', 200);
            
            // Show slice
            const slice = document.createElement('div');
            slice.innerHTML = 'üç∞';
            slice.style.cssText = `
                position: absolute;
                font-size: 4rem;
                animation: sliceOut 2s forwards;
                left: 50%;
                top: 50%;
            `;
            cake.appendChild(slice);
            
            setTimeout(() => slice.remove(), 2000);
            
            document.getElementById('cakeMessage').style.opacity = '1';
            
            confetti({
                particleCount: 200,
                spread: 100,
                origin: { y: 0.6 },
                colors: ['#ff006e', '#8338ec', '#06ffa5', '#ffd700']
            });
        }

        // Add smoke animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes smokeUp {
                to { transform: translateY(-50px) scale(2); opacity: 0; }
            }
            @keyframes sliceOut {
                0% { transform: translate(-50%, -50%) scale(0); }
                50% { transform: translate(-50%, -50%) scale(1.2) rotate(10deg); }
                100% { transform: translate(100px, 100px) scale(1) rotate(45deg); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // PHOTO FUNCTIONS
        async function handlePhotos(event) {
            const files = event.target.files;
            if (!files.length) return;

            document.getElementById('photoLoading').style.display = 'block';

            for (let file of files) {
                try {
                    const url = await uploadToCloudinary(file, 'image');
                    photos.push({
                        url: url,
                        date: new Date().toISOString()
                    });
                } catch (err) {
                    console.error('Upload failed:', err);
                    // Fallback to local
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        photos.push({
                            url: e.target.result,
                            date: new Date().toISOString(),
                            local: true
                        });
                    };
                    reader.readAsDataURL(file);
                }
            }

            localStorage.setItem('birthdayPhotos', JSON.stringify(photos));
            loadPhotos();
            document.getElementById('photoLoading').style.display = 'none';
        }

        function loadPhotos() {
            const grid = document.getElementById('photoGrid');
            grid.innerHTML = '';
            
            photos.forEach((photo, index) => {
                const item = document.createElement('div');
                item.className = 'photo-item';
                item.innerHTML = `
                    <img src="${photo.url}" alt="Memory" onclick="openLightbox('${photo.url}')">
                    <button class="delete" onclick="deletePhoto(${index})">√ó</button>
                `;
                grid.appendChild(item);
            });
        }

        function deletePhoto(index) {
            photos.splice(index, 1);
            localStorage.setItem('birthdayPhotos', JSON.stringify(photos));
            loadPhotos();
        }

        function openLightbox(url) {
            document.getElementById('lightboxImg').src = url;
            document.getElementById('lightbox').style.display = 'flex';
        }

        function closeLightbox() {
            document.getElementById('lightbox').style.display = 'none';
        }

        // VIDEO FUNCTIONS
        async function initCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('previewVideo').srcObject = stream;
            } catch (err) {
                console.log('Camera not available');
            }
        }

        function startRecording() {
            if (!stream) {
                initCamera().then(() => startRecordingActual());
                return;
            }
            startRecordingActual();
        }

        function startRecordingActual() {
            recordedChunks = [];
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            
            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) recordedChunks.push(e.data);
            };
            
            mediaRecorder.onstop = () => {
                videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(videoBlob);
                
                document.getElementById('previewVideo').classList.add('hidden');
                const recorded = document.getElementById('recordedVideo');
                recorded.classList.remove('hidden');
                recorded.src = url;
                
                document.getElementById('uploadVideoBtn').classList.remove('hidden');
            };
            
            mediaRecorder.start();
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        }

        async function uploadVideo() {
            if (!videoBlob) return;
            
            document.getElementById('videoLoading').style.display = 'block';
            
            try {
                const url = await uploadToCloudinary(videoBlob, 'video');
                const author = prompt('‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ:', 'Friend') || 'Anonymous';
                
                videos.push({
                    url: url,
                    author: author,
                    date: new Date().toISOString()
                });
                
                localStorage.setItem('birthdayVideos', JSON.stringify(videos));
                loadVideos();
                
                // Reset
                document.getElementById('recordedVideo').classList.add('hidden');
                document.getElementById('previewVideo').classList.remove('hidden');
                document.getElementById('uploadVideoBtn').classList.add('hidden');
                document.getElementById('videoLoading').style.display = 'none';
                
                confetti({ particleCount: 100, spread: 70 });
                
            } catch (err) {
                alert('‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                document.getElementById('videoLoading').style.display = 'none';
            }
        }

        function loadVideos() {
            const list = document.getElementById('videosList');
            list.innerHTML = '';
            
            videos.forEach(video => {
                const card = document.createElement('div');
                card.className = 'video-card';
                card.innerHTML = `
                    <video controls src="${video.url}"></video>
                    <div class="video-info">
                        <strong style="color: var(--accent);">üë§ ${video.author}</strong>
                        <p style="color: #888; font-size: 0.85rem; margin-top: 5px;">
                            üéÇ ${new Date(video.date).toLocaleDateString('bn-BD')}
                        </p>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        // LETTER FUNCTIONS
        function saveLetter() {
            const author = document.getElementById('letterAuthor').value.trim() || 'Anonymous';
            const content = document.getElementById('letterContent').value.trim();
            
            if (!content) {
                alert('‡¶ö‡¶ø‡¶†‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!');
                return;
            }
            
            letters.push({
                author: author,
                content: content,
                date: new Date().toISOString()
            });
            
            localStorage.setItem('birthdayLetters', JSON.stringify(letters));
            loadLetters();
            clearLetter();
            
            confetti({
                particleCount: 50,
                colors: ['#ffd700', '#ff69b4']
            });
        }

        function clearLetter() {
            document.getElementById('letterAuthor').value = '';
            document.getElementById('letterContent').value = '';
        }

        function loadLetters() {
            const container = document.getElementById('savedLetters');
            // Keep header
            const header = container.querySelector('h3');
            container.innerHTML = '';
            container.appendChild(header);
            
            letters.slice().reverse().forEach(letter => {
                const item = document.createElement('div');
                item.className = 'letter-item';
                item.innerHTML = `
                    <div class="letter-author">üë§ ${letter.author}</div>
                    <div style="white-space: pre-wrap; line-height: 1.8;">${letter.content}</div>
                    <div class="letter-date">üìù ${new Date(letter.date).toLocaleString('bn-BD')}</div>
                `;
                container.appendChild(item);
            });
        }

        // CLOUDINARY UPLOAD
        async function uploadToCloudinary(file, type) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', UPLOAD_PRESET);
            
            const resourceType = type === 'video' ? 'video' : 'image';
            
            const response = await fetch(
                `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/${resourceType}/upload`,
                {
                    method: 'POST',
                    body: formData
                }
            );
            
            if (!response.ok) throw new Error('Upload failed');
            
            const data = await response.json();
            return data.secure_url;
        }

        // Get name from URL
        const urlParams = new URLSearchParams(window.location.search);
        const name = urlParams.get('name');
        if (name) {
            document.getElementById('birthdayName').textContent = decodeURIComponent(name);
        }
    </script>

</body>
</html>
